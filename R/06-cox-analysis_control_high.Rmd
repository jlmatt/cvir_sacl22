```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(skimr)
library(ecotox)
library(survival)
library(coxme)
library(stats)
#library(AICcmodavg) # used this for the AICcmodavg function to calculate AICcs quickly
library(janitor)
library(broom)
#library(ehahelper) # used this for the tidy function to extract values out of coxme.  https://rdrr.io/github/junkka/ehahelper/
library(survminer)
library(ggplot2)
```


# Data

```{r}
mort_dat <- read_rds(here::here("data", "derived", "mort_dat_final.rds"))
```

Create a new column in data frame for group (e.g., ULM-1, NNP-2)

```{r}
mort_dat <- mort_dat %>%
  mutate(group = str_sub(batch, end = -5)) %>%
  select(tag,group,batch,everything())
```

Create a new column in the data frame that represents "recovery."
* Seems the low salinity treatment ended on 10/20/22 and high salinity treatment ended on 11/01/2022.
* All animals in low treatment with death date on or before 10/20/22 will be considered "n" for recovery, all others in low treatment will get "y."
* All animals in high treatment with death date on or before 11/01/22 will be considered "n" for recovery, all others in low treatment will get "y."

Oysters pulled on day 9 for low salinity (day 1 = 10/12/2022)
Oysters pulled on day 21 for high salinity (day 1 = 10/12/2022)

```{r}
mort_dat <- mort_dat %>%
  mutate(recovery = if_else(death_date >= "2022-10-21" & treatment == "L","y",
                    if_else(death_date >= "2022-11-02" & treatment == "H","y",
                    if_else(death_date >= "2022-11-02" & treatment == "C","y","n"))))
```

Add in a censoring variable to data
If oysters survived or died in recovery (recovery = "y"), then they are censored "1", otherwise they are given "2", coding for mortality. 

```{r}
mort_dat <- mort_dat %>%
  mutate(censored = if_else(recovery == "y" | mortality == 0,1,2))
```

# Hypothesis Set

Alternative Hypotheses

Response: Days to Death (numeric)
Unit: Inidividual
r() indiciates random effect

	  	i.  Region + r(Tank) 
			ii. Region + r(Tank) + Site  
			iii.Region + r(Tank) + Site + Length
			iv. Region + r(Tank) + Site + Length + r(Group)
			v.  Region + r(Tank) + Site + Region x Site
			vi. Region + r(Tank) + Site + Region x Site + Length
			vii. Region + r(Tank) + Site + Region X Site + Length + r(Group)

# Data for Cox Models

Only considering data from the start of the test salinities (day "0" and beyond)
There are only a few, highly influential observations that occur before time 0.  Those mortalities are unlikely to be closely associated with the desired challenge.

```{r}
data <- mort_dat %>%
  filter(treatment == "C") %>%
  filter(day_of_death >= 0 | is.na(day_of_death)) 
```

```{r}
data %>%
  group_by(region) %>%
  summarize(ded = sum(censored == 2),
            tot = n())
```

```{r}
data$region<-as.factor(data$region)
data$growout_site<-as.factor(data$growout_site)
```

```{r}
data <- data %>%
  mutate(region = fct_relevel(region,c("S","N"))) %>%
  mutate(growout_site = fct_relevel(growout_site,c("CCB","COP")))
```

Give survivors a dummy variable for "day_of_death"
These animals won't count as dead, they will be censored

```{r}
data <- data %>%
  mutate(day_of_death = if_else(is.na(day_of_death), 22, day_of_death))
```

```{r}
data %>%
  group_by(growout_site, region) %>%
  filter(day_of_death < 22) %>%
  summarize(tot = sum(mortality))
```


# Run Cox Models

```{r}
c1 <- coxme(Surv(day_of_death,censored) ~ region + (1|tank), 
                 data = data)
summary(c1)

c1_fixed <- coxph(Surv(day_of_death,censored) ~ region, data = data)
summary(c1_fixed)
```

```{r}
c2 <- coxme(Surv(day_of_death,censored) ~ region + (1|tank) + growout_site, 
                 data = data)
summary(c2)

c2_fixed <- coxph(Surv(day_of_death,censored) ~ region + growout_site, data = data)
summary(c2_fixed)
```

```{r}
c3 <- coxme(Surv(day_of_death,censored) ~ region + (1|tank) + growout_site + length_mm,
                 data = data)
summary(c3)
```

```{r}
c4 <- coxme(Surv(day_of_death,censored) ~ region + (1|tank) + growout_site + length_mm + (1|group/region),
                 data = data)
summary(c4)
```

```{r}
#unbounded, do not include in model selection
c5 <- coxme(Surv(day_of_death,censored) ~ region + (1|tank) + growout_site + region * growout_site, 
                 data = data)
summary(c5)
```

```{r}
#unbounded, do not include in model selection
c6 <- coxme(Surv(day_of_death,censored) ~ region + (1|tank) + growout_site + region * growout_site + length_mm, 
                 data = data)
summary(c6)
```

```{r}
#unbounded, do not include in model selection
c7 <- coxme(Surv(day_of_death,censored) ~ region + (1|tank) + growout_site + region * growout_site + length_mm + (1|group/region),
                 data = data)
summary(c7)
```

# Model Selection and Interpretation

```{r}
models <- list(c1,c2,c3,c4)

control_models_parameters <- tibble(aictab(models))
```

Save data from models for making tables 

```{r}
saveRDS(control_models_parameters, file = here::here("data","derived","control_high_models_parameters"))
```


AICc calculated from:  AICc = AIC + 2k(k + 1) / (n - k - 1)
where AIC = 2k - 2*Integrated Log Lik

Best model is: 

			i. Region + r(Tank)


```{r}
# Extract coefficients and other information from best model
summary_A <- summary(c1)

mort <- summary_A$n[1]
total <- summary_A$n[2]

c1_summary<-tidy(c1)
c1_table <- c1_summary %>%
  mutate(HR = exp(estimate)) %>%
  mutate(HR.conf.low = exp(estimate - 1.96 * std.error)) %>%
  mutate(HR.conf.high = exp(estimate + 1.96 * std.error)) %>%
  select(term, estimate, std.error, conf.low, conf.high, HR, HR.conf.low, HR.conf.high, statistic, p.value)
c1_table

c1_r_effects<-as_tibble(ranef(c1)) %>%
  rownames_to_column() %>%
  rename(tank = rowname, coefficients = tank) %>%
  mutate(hr = exp(coefficients))
```

Save data for tables for best fitting model for a separate markdown

```{r}
saveRDS(mort, file = here::here("data","derived","06_best_model_control_high_mort"))

saveRDS(total, file = here::here("data","derived","06_best_model_control_high_total"))

saveRDS(c1_table, file = here::here("data","derived","06_best_model_control_high_fixed_effects"))

saveRDS(c1_r_effects, file = here::here("data","derived","06_best_model_control_high_random_effects"))
```


1) Proportional hazards assumption

From Kuitunen et al. 2021: 

"The fundamental assumption in the Cox model is that the hazards are proportional, which means that the relative hazard remains constant over time with different predictor or covariate levels."

Look at the Schoenfel Residuals vs. time to examine this assumption. 

Schoenfeld residuals measure the difference between the observed covariate values and their expected values at each event time for each individual in the dataset. When plotted against time, they indicate the effect of a covariate on the hazard rate over time. 

We will use the fixed version of model three (c5_fixed) to examine residual to test the proportion hazard assumption.

```{r}
test<-cox.zph(c1_fixed)
ggcoxzph(test)
```


Influential points

```{r}
t<-residuals(c1_fixed,type="deviance")

plot(t)

index <- 1: length(t)
abline(h = 0, lty = 2)  # Add a reference line at y = 0

# Fit and add a loess line
loess_line <- loess(t ~ index, span = 0.6)
lines(index, predict(loess_line), col = "red", lwd = 2)
```


